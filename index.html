import React, { useState, useEffect, useRef } from 'react';
import { Camera, FileText, Save, Upload, Trash2, Plus } from 'lucide-react';

// 模擬 API Config (實際開發時應從環境變數 process.env 讀取)
// 這裡展示如何結構化配置，但不暴露真實 Key
const API_CONFIG = {
  uploadEndpoint: "https://api.your-company.com/upload",
  apiKey: "HIDDEN_FOR_SECURITY_REASONS", // 實際部署時使用 process.env.REACT_APP_API_KEY
};

const InspectionApp = () => {
  // --- 狀態管理 ---
  const [projectInfo, setProjectInfo] = useState({
    projectName: 'B14A05632_機廠轉換軌標誌牌改善案',
    location: '機廠',
    recorder: '王大明', // 改為記錄人員
    contractor: '長德開發工程有限公司',
    date: new Date().toISOString().split('T')[0],
    weather: '晴',
  });

  // 預設檢查項目 (移除 status 欄位)
  const [items, setItems] = useState([
    { id: 1, category: '施作前(正面)', name: '說明:應清楚看到標誌牌內容及立柱本體於照片中', photo: null, note: '' },
    { id: 2, category: '施作前(反面)', name: '說明:應清楚看到標誌牌內容及立柱本體於照片中', photo: null, note: '' },
    { id: 3, category: '施作前(反面)', name: '說明:應清楚看到標誌牌內容及立柱本體於照片中', photo: null, note: '' },
    { id: 4, category: '施作後(反面)', name: '說明:應清楚看到標誌牌內容及立柱本體於照片中', photo: null, note: '施工架踏板未滿鋪' },
  ]);

  const [isPrinting, setIsPrinting] = useState(false);

  // --- 功能函數 ---

  // 處理照片上傳 (讀取本地檔案並轉為 Base64 預覽)
  const handlePhotoUpload = (itemId, event) => {
    const file = event.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onloadend = () => {
        setItems(prevItems => 
          prevItems.map(item => 
            item.id === itemId ? { ...item, photo: reader.result } : item
          )
        );
      };
      reader.readAsDataURL(file);
    }
  };

  // 刪除照片
  const removePhoto = (itemId) => {
    setItems(prevItems => 
      prevItems.map(item => 
        item.id === itemId ? { ...item, photo: null } : item
      )
    );
  };

  // 更新備註
  const updateNote = (itemId, text) => {
    setItems(prevItems => 
      prevItems.map(item => 
        item.id === itemId ? { ...item, note: text } : item
      )
    );
  };

  // 新增檢查項目
  const addItem = () => {
    const newId = items.length > 0 ? Math.max(...items.map(i => i.id)) + 1 : 1;
    setItems([...items, { id: newId, category: '新增項目', name: '', photo: null, note: '' }]);
  };

  // 處理列印/PDF匯出
  const handlePrint = () => {
    setIsPrinting(true);
    setTimeout(() => {
      window.print();
      setIsPrinting(false);
    }, 100);
  };

  return (
    <div className="min-h-screen bg-gray-50 font-sans">
      
      {/* --- 頂部導覽列 (列印時隱藏) --- */}
      <nav className="bg-blue-900 text-white p-4 shadow-md print:hidden sticky top-0 z-50">
        <div className="container mx-auto flex justify-between items-center">
          <div className="flex items-center space-x-2">
            <FileText size={24} />
            <h1 className="text-xl font-bold">工程施工紀錄系統</h1>
          </div>
          <button 
            onClick={handlePrint}
            className="bg-white text-blue-900 px-4 py-2 rounded-lg font-bold flex items-center hover:bg-blue-50 transition-colors"
          >
            <Save size={18} className="mr-2" />
            匯出 PDF 報告
          </button>
        </div>
      </nav>

      {/* --- 主要內容區 --- */}
      <div className="container mx-auto p-4 max-w-4xl print:p-0 print:max-w-full">
        
        {/* A4 紙張模擬容器 */}
        <div className="bg-white shadow-lg rounded-xl p-8 print:shadow-none print:p-0 print:rounded-none min-h-[29.7cm]">
          
          {/* 報告表頭 */}
          <div className="border-b-2 border-gray-800 pb-4 mb-6">
            <h2 className="text-3xl font-bold text-center text-gray-800 mb-2">工程現場施工紀錄表</h2>
            <div className="grid grid-cols-2 gap-4 text-sm mt-4">
              <div className="flex flex-col">
                <span className="text-gray-500 text-xs">工程名稱</span>
                <input 
                  value={projectInfo.projectName}
                  onChange={(e) => setProjectInfo({...projectInfo, projectName: e.target.value})}
                  className="font-bold text-lg border-b border-gray-300 focus:outline-none focus:border-blue-500 print:border-none" 
                />
              </div>
              <div className="flex flex-col">
                <span className="text-gray-500 text-xs">施工地點</span>
                <input 
                  value={projectInfo.location}
                  onChange={(e) => setProjectInfo({...projectInfo, location: e.target.value})}
                  className="border-b border-gray-300 focus:outline-none focus:border-blue-500 print:border-none" 
                />
              </div>
              <div className="flex space-x-4">
                <div className="flex flex-col w-1/2">
                  <span className="text-gray-500 text-xs">記錄人員</span>
                  <input 
                    value={projectInfo.recorder}
                    onChange={(e) => setProjectInfo({...projectInfo, recorder: e.target.value})}
                    className="border-b border-gray-300 focus:outline-none focus:border-blue-500 print:border-none" 
                  />
                </div>
                <div className="flex flex-col w-1/2">
                  <span className="text-gray-500 text-xs">承造廠商</span>
                  <input 
                    value={projectInfo.contractor}
                    onChange={(e) => setProjectInfo({...projectInfo, contractor: e.target.value})}
                    className="border-b border-gray-300 focus:outline-none focus:border-blue-500 print:border-none" 
                  />
                </div>
              </div>
              <div className="flex space-x-4">
                <div className="flex flex-col w-1/2">
                  <span className="text-gray-500 text-xs">施作日期</span>
                  <input 
                    type="date"
                    value={projectInfo.date}
                    onChange={(e) => setProjectInfo({...projectInfo, date: e.target.value})}
                    className="border-b border-gray-300 focus:outline-none focus:border-blue-500 print:border-none" 
                  />
                </div>
                <div className="flex flex-col w-1/2">
                  <span className="text-gray-500 text-xs">天氣</span>
                  <select 
                    value={projectInfo.weather}
                    onChange={(e) => setProjectInfo({...projectInfo, weather: e.target.value})}
                    className="border-b border-gray-300 focus:outline-none focus:border-blue-500 bg-transparent print:appearance-none" 
                  >
                    <option value="晴">晴</option>
                    <option value="陰">陰</option>
                    <option value="雨">雨</option>
                  </select>
                </div>
              </div>
            </div>
          </div>

          {/* 檢查列表 - 調整版面配置 (移除判定欄位) */}
          <div className="space-y-6">
            <div className="grid grid-cols-12 gap-2 text-sm font-bold bg-gray-100 p-2 rounded print:bg-gray-200">
              <div className="col-span-1 text-center">項次</div>
              <div className="col-span-5">紀錄項目</div>
              {/* 移除判定標題 */}
              <div className="col-span-6 text-center">現場照片/備註</div>
            </div>

            {items.map((item, index) => (
              <div key={item.id} className="grid grid-cols-12 gap-4 border-b border-gray-200 pb-4 items-start break-inside-avoid">
                {/* 序號 */}
                <div className="col-span-1 text-center py-2 font-mono text-gray-500">{index + 1}</div>

                {/* 項目名稱 - 增加寬度 */}
                <div className="col-span-5 py-2">
                  <div className="text-xs text-blue-600 font-bold mb-1">{item.category}</div>
                  <input 
                    value={item.name}
                    onChange={(e) => {
                      const newItems = [...items];
                      newItems[index].name = e.target.value;
                      setItems(newItems);
                    }}
                    placeholder="輸入紀錄項目..."
                    className="w-full bg-transparent focus:outline-none focus:border-b focus:border-blue-500 font-medium"
                  />
                </div>

                {/* 照片與備註區 - 增加寬度 */}
                <div className="col-span-6 space-y-2">
                  {/* 照片預覽與上傳 */}
                  <div className="relative w-full h-48 bg-gray-100 rounded-lg border-2 border-dashed border-gray-300 flex items-center justify-center overflow-hidden group hover:border-blue-400 transition-colors">
                    {item.photo ? (
                      <>
                        <img src={item.photo} alt="現場照片" className="w-full h-full object-cover" />
                        <button 
                          onClick={() => removePhoto(item.id)}
                          className="absolute top-1 right-1 bg-red-500 text-white p-1 rounded-full opacity-0 group-hover:opacity-100 transition-opacity print:hidden"
                        >
                          <Trash2 size={12} />
                        </button>
                      </>
                    ) : (
                      <label className="cursor-pointer flex flex-col items-center justify-center w-full h-full text-gray-400 hover:text-blue-500 print:hidden">
                        <Camera size={24} />
                        <span className="text-xs mt-1">點擊拍照</span>
                        <input 
                          type="file" 
                          accept="image/*" 
                          capture="environment" // 手機優先使用後鏡頭
                          className="hidden" 
                          onChange={(e) => handlePhotoUpload(item.id, e)}
                        />
                      </label>
                    )}
                    {/* 列印時若無照片顯示提示 */}
                    <div className="hidden print:flex w-full h-full items-center justify-center text-gray-300 text-xs">
                      {!item.photo && "無照片"}
                    </div>
                  </div>

                  {/* 備註輸入 */}
                  <textarea 
                    value={item.note}
                    onChange={(e) => updateNote(item.id, e.target.value)}
                    placeholder="輸入說明或備註..."
                    className="w-full text-xs p-2 border rounded resize-none focus:ring-1 focus:ring-blue-500 focus:outline-none print:border-none print:p-0 print:text-sm"
                    rows={2}
                  />
                </div>
              </div>
            ))}
          </div>

          {/* 新增項目按鈕 (列印時隱藏) */}
          <button 
            onClick={addItem}
            className="w-full mt-6 py-3 border-2 border-dashed border-gray-300 text-gray-500 rounded-lg hover:border-blue-500 hover:text-blue-500 transition-colors flex items-center justify-center print:hidden"
          >
            <Plus size={20} className="mr-2" /> 新增紀錄項目
          </button>

          {/* 移除簽名欄位 */}
          
          <div className="mt-8 pt-4 border-t border-gray-200 text-xs text-center text-gray-400 print:text-gray-600">
            表單產生時間：{new Date().toLocaleString()} | 系統版本：v1.3.0
          </div>
        </div>
      </div>

      {/* CSS 用於隱藏列印時不必要的元素 */}
      <style>{`
        @media print {
          @page {
            size: A4;
            margin: 1cm;
          }
          body {
            background: white;
            -webkit-print-color-adjust: exact;
          }
        }
      `}</style>
    </div>
  );
};

export default InspectionApp;